<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste YuStream Smart TV Player</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .player-container {
            width: 100%;
            height: 600px;
            background: #111;
            border: 2px solid #333;
            position: relative;
            margin: 20px 0;
        }
        
        #video-player {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background: #007AFF;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056CC;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #222;
            border-radius: 5px;
        }
        
        .log {
            margin: 20px 0;
            padding: 15px;
            background: #111;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ Teste YuStream Smart TV Player</h1>
        
        <div class="status">
            <h3>Status do Player</h3>
            <p>Status: <span id="player-status">NÃ£o inicializado</span></p>
            <p>Dispositivo: <span id="device-info">Detectando...</span></p>
            <p>Token: <span id="token-status">NÃ£o obtido</span></p>
            <p>Stream: <span id="stream-status">Verificando...</span></p>
        </div>
        
        <div class="controls">
            <button id="btn-auth">1. Testar AutenticaÃ§Ã£o</button>
            <button id="btn-stream">2. Testar Status Stream</button>
            <button id="btn-player">3. Inicializar Player</button>
            <button id="btn-qualities">4. Mostrar Qualidades</button>
            <button id="btn-fullscreen">5. Toggle Fullscreen</button>
            <button id="btn-play">Play</button>
            <button id="btn-pause">Pause</button>
            <button id="btn-reload">Reload</button>
            <button id="btn-clear">Limpar Logs</button>
        </div>
        
        <div class="controls">
            <strong>Trocar Qualidade:</strong>
            <button id="btn-quality-720">720p</button>
            <button id="btn-quality-1080">1080p</button>
            <button id="btn-quality-fonte">Fonte</button>
            <button id="btn-quality-360">360p</button>
        </div>
        
        <div class="player-container">
            <video id="video-player" controls></video>
        </div>
        
        <div class="log">
            <h3>Logs do Player</h3>
            <div id="log-content"></div>
        </div>
    </div>

    <!-- ConfiguraÃ§Ã£o do servidor -->
    <script>
        window.YUSTREAM_CONFIG = {
            SERVER_URL: 'http://localhost/api',
            STREAM_URL: 'http://localhost:8080',
            ENVIRONMENT: 'production',
            PLATFORM: 'test'
        };
    </script>

    <!-- Scripts do YuStream -->
    <script src="src/js/core/auth.js"></script>
    <script src="src/js/core/streamPlayerAdvanced.js"></script>
    <script src="src/js/ui/qualitySelectorSimple.js"></script>
    <script src="src/js/utils/device.js"></script>
    <script src="src/js/utils/toast.js"></script>

    <script>
        let playerInstance = null;
        
        // FunÃ§Ã£o de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('log-content');
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#ffffff';
            
            logContent.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            
            console.log(`[Test] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('log-content').innerHTML = '';
        }
        
        // Atualizar informaÃ§Ãµes
        function updateStatus() {
            document.getElementById('device-info').textContent = 
                window.deviceUtils ? window.deviceUtils.getInfo().platform : 'NÃ£o detectado';
                
            document.getElementById('token-status').textContent = 
                window.authService?.getToken() ? 'Obtido' : 'NÃ£o obtido';
                
            document.getElementById('player-status').textContent = 
                playerInstance ? playerInstance.status : 'NÃ£o inicializado';
        }
        
        // Testes
        async function testAuth() {
            try {
                log('Testando autenticaÃ§Ã£o...', 'info');
                
                // Login de teste
                const result = await window.authService.login('admin', 'admin123');
                
                if (result.success) {
                    log('âœ… Login realizado com sucesso', 'success');
                } else {
                    log(`âŒ Erro no login: ${result.error}`, 'error');
                }
                
                updateStatus();
                
            } catch (error) {
                log(`âŒ Erro na autenticaÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        async function testStreamStatus() {
            try {
                log('Verificando status da stream...', 'info');
                
                const status = await window.authService.getStreamStatus();
                log(`ðŸ“Š Stream ${status.online ? 'ONLINE' : 'OFFLINE'}`, status.online ? 'success' : 'error');
                
                document.getElementById('stream-status').textContent = 
                    status.online ? 'Online' : 'Offline';
                
                // TambÃ©m testar API de qualidades
                if (window.authService.getToken()) {
                    try {
                        const serverUrl = window.YUSTREAM_CONFIG?.SERVER_URL || 'https://yustream.yurisp.com.br';
                        const qualitiesResponse = await fetch(`${serverUrl}/stream/qualities`, {
                            headers: {
                                'Authorization': `Bearer ${window.authService.getToken()}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (qualitiesResponse.ok) {
                            const qualitiesData = await qualitiesResponse.json();
                            log(`ðŸ“Š API Qualidades: ${qualitiesData.qualities?.length || 0} total, ${qualitiesData.activeQualities || 0} ativas`, 'info');
                            
                            if (qualitiesData.qualities) {
                                qualitiesData.qualities.forEach(q => {
                                    log(`  - ${q.displayName}: ${q.active ? 'ATIVA' : 'INATIVA'}`, q.active ? 'success' : 'info');
                                });
                            }
                        } else {
                            log(`âŒ Erro na API qualidades: HTTP ${qualitiesResponse.status}`, 'error');
                        }
                    } catch (error) {
                        log(`âŒ Erro ao testar API qualidades: ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`âŒ Erro ao verificar stream: ${error.message}`, 'error');
            }
        }
        
        async function testPlayer() {
            try {
                log('Inicializando player...', 'info');
                
                if (playerInstance) {
                    playerInstance.destroy();
                }
                
                playerInstance = new AdvancedStreamPlayer({
                    onStatusChange: (status) => {
                        log(`ðŸŽ¬ Status mudou: ${status}`, 'info');
                        document.getElementById('player-status').textContent = status;
                    },
                    onError: (error) => {
                        log(`âŒ Erro do player: ${error}`, 'error');
                    },
                    onStreamOnlineChange: (isOnline) => {
                        log(`ðŸ“¡ Stream ${isOnline ? 'ONLINE' : 'OFFLINE'}`, isOnline ? 'success' : 'error');
                    },
                    getStreamToken: () => window.authService.getStreamToken()
                });
                
                await playerInstance.initialize();
                
                updateStatus();
                
            } catch (error) {
                log(`âŒ Erro ao inicializar player: ${error.message}`, 'error');
            }
        }
        
        function testPlay() {
            if (playerInstance) {
                playerInstance.play();
                log('â–¶ï¸ Play solicitado', 'info');
            } else {
                log('âŒ Player nÃ£o inicializado', 'error');
            }
        }
        
        function testPause() {
            if (playerInstance) {
                playerInstance.pause();
                log('â¸ï¸ Pause solicitado', 'info');
            } else {
                log('âŒ Player nÃ£o inicializado', 'error');
            }
        }
        
        function testReload() {
            if (playerInstance) {
                playerInstance.retry();
                log('ðŸ”„ Reload solicitado', 'info');
            } else {
                log('âŒ Player nÃ£o inicializado', 'error');
            }
        }
        
        function showQualities() {
            if (playerInstance && playerInstance.isReady) {
                const qualities = playerInstance.getAvailableQualities();
                log('ðŸ“Š Qualidades disponÃ­veis:', 'info');
                
                qualities.forEach(q => {
                    const status = q.current ? 'â–¶ï¸ ATUAL' : (q.active ? 'âšª DisponÃ­vel' : 'âš« Inativa');
                    const latency = q.lowLatency ? ' [Baixa LatÃªncia]' : '';
                    log(`  ${status} ${q.displayName}${latency}`, q.current ? 'success' : 'info');
                    
                    // Mostrar URL para debug (verificar se tem token)
                    if (playerInstance.availableQualities) {
                        const fullQuality = playerInstance.availableQualities.find(fq => fq.name === q.name);
                        if (fullQuality) {
                            const hasToken = fullQuality.url.includes('token=');
                            log(`    URL: ${fullQuality.url.substring(0, 80)}... ${hasToken ? 'âœ… COM TOKEN' : 'âŒ SEM TOKEN'}`, hasToken ? 'success' : 'error');
                        }
                    }
                });
                
                const current = playerInstance.getCurrentQuality();
                if (current) {
                    log(`ðŸŽ¯ Qualidade atual: ${current.displayName}`, 'success');
                    log(`ðŸ“¡ URL: ${current.url}`, 'info');
                }
                
                // Testar seletor de qualidades
                log('ðŸŽ¬ Testando seletor de qualidades...', 'info');
                
                // Criar seletor de teste
                const testSelector = new SimpleQualitySelector({
                    onQualityChange: async (qualityName) => {
                        log(`ðŸŽ¯ Qualidade selecionada: ${qualityName}`, 'success');
                        await changeQuality(qualityName);
                    }
                });
                
                // Atualizar com qualidades e mostrar
                testSelector.updateQualities(qualities);
                testSelector.show();
                
            } else {
                log('âŒ Player nÃ£o estÃ¡ pronto', 'error');
            }
        }
        
        async function changeQuality(qualityName) {
            if (playerInstance && playerInstance.isReady) {
                try {
                    log(`ðŸŽ¯ Mudando para qualidade: ${qualityName}`, 'info');
                    await playerInstance.changeQuality(qualityName);
                    log(`âœ… Qualidade alterada para: ${qualityName}`, 'success');
                } catch (error) {
                    log(`âŒ Erro ao mudar qualidade: ${error.message}`, 'error');
                }
            } else {
                log('âŒ Player nÃ£o estÃ¡ pronto', 'error');
            }
        }
        
        function testFullscreen() {
            try {
                log('ðŸ–¥ï¸ Testando fullscreen...', 'info');
                
                const playerScreen = document.getElementById('player-screen');
                if (!playerScreen) {
                    log('âŒ Elemento player-screen nÃ£o encontrado', 'error');
                    return;
                }
                
                const isCurrentlyFullscreen = playerScreen.classList.contains('fullscreen');
                
                if (isCurrentlyFullscreen) {
                    playerScreen.classList.remove('fullscreen');
                    log('âœ… Fullscreen desativado', 'success');
                } else {
                    playerScreen.classList.add('fullscreen');
                    log('âœ… Fullscreen ativado', 'success');
                }
                
            } catch (error) {
                log(`âŒ Erro no fullscreen: ${error.message}`, 'error');
            }
        }
        
        // Inicializar quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            log('ðŸš€ PÃ¡gina de teste carregada', 'success');
            updateStatus();
            
            // Configurar event listeners dos botÃµes
            document.getElementById('btn-auth').addEventListener('click', testAuth);
            document.getElementById('btn-stream').addEventListener('click', testStreamStatus);
            document.getElementById('btn-player').addEventListener('click', testPlayer);
            document.getElementById('btn-qualities').addEventListener('click', showQualities);
            document.getElementById('btn-fullscreen').addEventListener('click', testFullscreen);
            document.getElementById('btn-play').addEventListener('click', testPlay);
            document.getElementById('btn-pause').addEventListener('click', testPause);
            document.getElementById('btn-reload').addEventListener('click', testReload);
            document.getElementById('btn-clear').addEventListener('click', clearLogs);
            
            // BotÃµes de qualidade
            document.getElementById('btn-quality-720').addEventListener('click', () => changeQuality('720p'));
            document.getElementById('btn-quality-1080').addEventListener('click', () => changeQuality('1080p'));
            document.getElementById('btn-quality-fonte').addEventListener('click', () => changeQuality('Fonte'));
            document.getElementById('btn-quality-360').addEventListener('click', () => changeQuality('360p'));
            
            log('âœ… Event listeners configurados', 'success');
            
            // Atualizar status a cada 2 segundos
            setInterval(updateStatus, 2000);
        });
        
        // Log de erros globais
        window.addEventListener('error', (e) => {
            log(`ðŸ’¥ Erro global: ${e.error?.message || e.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            log(`ðŸ’¥ Promise rejeitada: ${e.reason?.message || e.reason}`, 'error');
        });
    </script>
</body>
</html>

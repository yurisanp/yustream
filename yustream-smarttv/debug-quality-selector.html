<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Seletor de Qualidades</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #222;
            border-radius: 10px;
        }
        
        button {
            padding: 10px 20px;
            background: #007AFF;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056CC;
        }
        
        .log {
            background: #111;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .status {
            padding: 10px;
            background: #333;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Debug - Seletor de Qualidades</h1>
        
        <div class="section">
            <h3>1. Configura√ß√£o</h3>
            <div class="status">
                <p>Servidor: <span id="server-config">Carregando...</span></p>
                <p>Auth: <span id="auth-status">N√£o autenticado</span></p>
            </div>
            <button onclick="testConfig()">Verificar Configura√ß√£o</button>
            <button onclick="testLogin()">Fazer Login</button>
        </div>
        
        <div class="section">
            <h3>2. API de Qualidades</h3>
            <div class="status">
                <p>Status: <span id="api-status">N√£o testado</span></p>
                <p>Qualidades: <span id="qualities-count">0</span></p>
            </div>
            <button onclick="testQualitiesAPI()">Testar API Qualidades</button>
            <button onclick="showAPIResponse()">Ver Resposta Completa</button>
        </div>
        
        <div class="section">
            <h3>3. Seletor de Qualidades</h3>
            <div class="status">
                <p>Seletor: <span id="selector-status">N√£o criado</span></p>
                <p>Vis√≠vel: <span id="selector-visible">N√£o</span></p>
            </div>
            <button onclick="createSelector()">Criar Seletor</button>
            <button onclick="showSelector()">Mostrar Seletor</button>
            <button onclick="hideSelector()">Esconder Seletor</button>
            <button onclick="testWithMockData()">Testar com Dados Mock</button>
        </div>
        
        <div class="section">
            <h3>4. Logs</h3>
            <button onclick="clearLogs()">Limpar Logs</button>
            <div class="log" id="log-content"></div>
        </div>
    </div>

    <!-- Configura√ß√£o -->
    <script>
        window.YUSTREAM_CONFIG = {
            SERVER_URL: 'http://localhost/api',
            STREAM_URL: 'http://localhost:8080',
            ENVIRONMENT: 'development',
            PLATFORM: 'debug'
        };
    </script>

    <!-- Scripts -->
    <script src="src/js/core/auth.js"></script>
    <script src="src/js/ui/qualitySelectorSimple.js"></script>
    <script src="src/js/utils/device.js"></script>
    <script src="src/js/utils/toast.js"></script>

    <script>
        let testSelector = null;
        let lastAPIResponse = null;
        
        // Fun√ß√£o de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('log-content');
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#ffffff';
            
            logContent.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            
            console.log(`[Debug] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('log-content').innerHTML = '';
        }
        
        function updateStatus() {
            document.getElementById('server-config').textContent = 
                window.YUSTREAM_CONFIG ? `${window.YUSTREAM_CONFIG.SERVER_URL}` : 'N√£o configurado';
                
            document.getElementById('auth-status').textContent = 
                window.authService?.isAuthenticated() ? 'Autenticado' : 'N√£o autenticado';
                
            document.getElementById('selector-status').textContent = 
                testSelector ? 'Criado' : 'N√£o criado';
                
            document.getElementById('selector-visible').textContent = 
                testSelector?.isVisible ? 'Sim' : 'N√£o';
        }
        
        // Testes
        function testConfig() {
            log('üîß Testando configura√ß√£o...', 'info');
            log(`Server: ${window.YUSTREAM_CONFIG?.SERVER_URL}`, 'info');
            log(`Stream: ${window.YUSTREAM_CONFIG?.STREAM_URL}`, 'info');
            log(`Auth Service: ${typeof window.authService}`, 'info');
            log(`SimpleQualitySelector: ${typeof window.SimpleQualitySelector}`, 'info');
            updateStatus();
        }
        
        async function testLogin() {
            try {
                log('üîë Fazendo login...', 'info');
                const result = await window.authService.login('admin', 'admin123');
                
                if (result.success) {
                    log('‚úÖ Login realizado', 'success');
                } else {
                    log(`‚ùå Erro no login: ${result.error}`, 'error');
                }
                
                updateStatus();
            } catch (error) {
                log(`‚ùå Erro no login: ${error.message}`, 'error');
            }
        }
        
        async function testQualitiesAPI() {
            try {
                log('üìä Testando API de qualidades...', 'info');
                
                if (!window.authService.getToken()) {
                    log('‚ùå N√£o autenticado, fa√ßa login primeiro', 'error');
                    return;
                }
                
                const serverUrl = window.YUSTREAM_CONFIG?.SERVER_URL || 'https://yustream.yurisp.com.br';
                const response = await fetch(`${serverUrl}/stream/qualities`, {
                    headers: {
                        'Authorization': `Bearer ${window.authService.getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üì° Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    lastAPIResponse = data;
                    
                    log(`üìä Total qualidades: ${data.qualities?.length || 0}`, 'info');
                    log(`üìä Qualidades ativas: ${data.activeQualities || 0}`, 'info');
                    
                    document.getElementById('qualities-count').textContent = 
                        `${data.activeQualities || 0}/${data.qualities?.length || 0}`;
                    
                    document.getElementById('api-status').textContent = 'OK';
                    
                    if (data.qualities) {
                        data.qualities.forEach(q => {
                            log(`  - ${q.displayName}: ${q.active ? 'ATIVA' : 'INATIVA'}`, q.active ? 'success' : 'info');
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Erro HTTP: ${errorText}`, 'error');
                    document.getElementById('api-status').textContent = `Erro ${response.status}`;
                }
                
            } catch (error) {
                log(`‚ùå Erro na API: ${error.message}`, 'error');
                document.getElementById('api-status').textContent = 'Erro';
            }
        }
        
        function showAPIResponse() {
            if (lastAPIResponse) {
                log('üìã Resposta completa da API:', 'info');
                log(JSON.stringify(lastAPIResponse, null, 2), 'info');
            } else {
                log('‚ùå Nenhuma resposta da API dispon√≠vel', 'error');
            }
        }
        
        function createSelector() {
            try {
                log('üé¨ Criando seletor...', 'info');
                
                if (testSelector) {
                    testSelector.destroy();
                }
                
                testSelector = new SimpleQualitySelector({
                    onQualityChange: (qualityName) => {
                        log(`üéØ Qualidade selecionada: ${qualityName}`, 'success');
                    }
                });
                
                log('‚úÖ Seletor criado', 'success');
                updateStatus();
                
            } catch (error) {
                log(`‚ùå Erro ao criar seletor: ${error.message}`, 'error');
            }
        }
        
        function showSelector() {
            if (!testSelector) {
                log('‚ùå Seletor n√£o foi criado', 'error');
                return;
            }
            
            log('üëÅÔ∏è Mostrando seletor...', 'info');
            testSelector.show();
            updateStatus();
        }
        
        function hideSelector() {
            if (testSelector) {
                log('üëÅÔ∏è Escondendo seletor...', 'info');
                testSelector.hide();
                updateStatus();
            }
        }
        
        function testWithMockData() {
            if (!testSelector) {
                createSelector();
            }
            
            log('üß™ Testando com dados mock...', 'info');
            
            const mockQualities = [
                {
                    name: '720p',
                    displayName: '720p HD Baixa latencia',
                    description: 'Qualidade HD 720p com baixa lat√™ncia',
                    active: true,
                    current: true,
                    priority: 4,
                    lowLatency: true
                },
                {
                    name: '1080p',
                    displayName: '1080p Full HD Baixa latencia',
                    description: 'Qualidade Full HD 1080p com baixa lat√™ncia',
                    active: true,
                    current: false,
                    priority: 3,
                    lowLatency: true
                },
                {
                    name: 'Fonte',
                    displayName: 'Fonte Original',
                    description: 'Qualidade original da fonte',
                    active: true,
                    current: false,
                    priority: 1,
                    lowLatency: false
                },
                {
                    name: '360p',
                    displayName: '360p SD',
                    description: 'Qualidade SD 360p',
                    active: false,
                    current: false,
                    priority: 5,
                    lowLatency: false
                }
            ];
            
            testSelector.updateQualities(mockQualities);
            testSelector.show();
            
            log('‚úÖ Dados mock aplicados', 'success');
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Debug page carregada', 'success');
            updateStatus();
            setInterval(updateStatus, 2000);
        });
        
        // Log de erros
        window.addEventListener('error', (e) => {
            log(`üí• Erro: ${e.error?.message || e.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            log(`üí• Promise rejeitada: ${e.reason?.message || e.reason}`, 'error');
        });
    </script>
</body>
</html>

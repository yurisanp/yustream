<?xml version="1.0" encoding="UTF-8"?>
<!-- 
    Configuração do OvenMediaEngine para múltiplas entradas RTMP com adaptive bitrate
    
    Como usar:
    1. Configure seu encoder para enviar streams RTMP para diferentes qualidades:
       - rtmp://seu-servidor:1935/live/4k_input
       - rtmp://seu-servidor:1935/live/1080p_input  
       - rtmp://seu-servidor:1935/live/720p_input
       - rtmp://seu-servidor:1935/live/480p_input
       - rtmp://seu-servidor:1935/live/360p_input
    
    2. O OME irá processar cada entrada com bypass (sem re-encoding)
    3. Criará uma playlist LLHLS com adaptive bitrate em:
       - https://seu-servidor:3333/live/abr.m3u8
    
    4. Os clientes receberão automaticamente a melhor qualidade baseada na largura de banda
-->
<VirtualHost>
    <Name>default</Name>

    <Host>
        <Names>
            <Name>*</Name>
        </Names>
        <TLS>
            <CertPath>/opt/ovenmediaengine/bin/origin_conf/cert.pem</CertPath>
            <KeyPath>/opt/ovenmediaengine/bin/origin_conf/privkey.pem</KeyPath>
            <ChainCertPath>/opt/ovenmediaengine/bin/origin_conf/chain.pem</ChainCertPath>
        </TLS>
    </Host>

    <!-- Admission Webhooks para controle de acesso -->
    <AdmissionWebhooks>
        <ControlServerUrl>http://yustream-auth:3001/webhook/admission</ControlServerUrl>
        <SecretKey>yustream-webhook-secret-2024</SecretKey>
        <Timeout>3000</Timeout>
        <Enables>
            <Providers>rtmp</Providers>
            <Publishers>llhls</Publishers>
        </Enables>
    </AdmissionWebhooks>

    <Applications>
        <Application>
            <Name>live</Name>
            <Type>live</Type>

            <!-- Perfis de saída com múltiplas qualidades -->
            <OutputProfiles>
                <!-- Perfil ABR (Adaptive Bitrate) com múltiplas qualidades -->
                <OutputProfile>
                    <Name>abr_stream</Name>
                    <OutputStreamName>${OriginStreamName}</OutputStreamName>
                    <Playlist>
                        <Name>for LLHLS</Name>
                        <FileName>abr</FileName>
                        <Rendition>
                            <Name>Fonte</Name>
                            <Video>fonte_video</Video>
                            <Audio>bypass_audio</Audio>
                        </Rendition>
                        <Rendition>
                            <Name>1080p</Name>
                            <Video>1080p_video</Video>
                            <Audio>bypass_audio</Audio>
                        </Rendition>
                        <Rendition>
                            <Name>720p</Name>
                            <Video>720p_video</Video>
                            <Audio>bypass_audio</Audio>
                        </Rendition>
                    </Playlist>
                    <Encodes>
                        <!-- Configuração de áudio -->
                        <Audio>
                            <Name>bypass_audio</Name>
                            <Bypass>True</Bypass>
                        </Audio>
                        <!-- Configurações de vídeo para diferentes qualidades -->
                        <Video>
                            <Name>fonte_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                        <Video>
                            <Name>1080p_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                        <Video>
                            <Name>720p_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                    </Encodes>
                </OutputProfile>
            </OutputProfiles>

            <!-- Configurações de provedores -->
            <Providers>
                <RTMP>
                    <BlockDuplicateStreamName>false</BlockDuplicateStreamName>
                    <Port>1935</Port>
                    <WorkerCount>1</WorkerCount>
                </RTMP>
            </Providers>

            <!-- Mapeamento de streams para diferentes qualidades -->
            <StreamMaps>
                <!-- Mapeamento para stream 4K -->
                <StreamMap>
                    <Name>fonte_stream</Name>
                    <SourceStream>fonte_input</SourceStream>
                    <OutputProfile>abr_stream</OutputProfile>
                    <OutputStream>fonte_output</OutputStream>
                </StreamMap>
                <!-- Mapeamento para stream 1080p -->
                <StreamMap>
                    <Name>1080p_stream</Name>
                    <SourceStream>1080p_input</SourceStream>
                    <OutputProfile>abr_stream</OutputProfile>
                    <OutputStream>1080p_output</OutputStream>
                </StreamMap>
                <!-- Mapeamento para stream 720p -->
                <StreamMap>
                    <Name>720p_stream</Name>
                    <SourceStream>720p_input</SourceStream>
                    <OutputProfile>abr_stream</OutputProfile>
                    <OutputStream>720p_output</OutputStream>
                </StreamMap>
            </StreamMaps>

            <!-- Configurações de publicadores -->
            <Publishers>
                <AppWorkerCount>1</AppWorkerCount>
                <StreamWorkerCount>1</StreamWorkerCount>               
                <LLHLS>
                    <SegmentDuration>4</SegmentDuration>
                    <SegmentCount>10</SegmentCount>
                    <PartHoldBack>7</PartHoldBack>
                    <CrossDomains>
                        <Url>*</Url>
                    </CrossDomains>
                    <!-- Configurações para adaptive bitrate -->
                    <ChunkDuration>0.5</ChunkDuration>
                    <SegmentDuration>4</SegmentDuration>
                    <SegmentCount>10</SegmentCount>
                    <PartHoldBack>7</PartHoldBack>
                    <PartDuration>0.5</PartDuration>
                </LLHLS>  
            </Publishers>
        </Application>
    </Applications>
</VirtualHost>
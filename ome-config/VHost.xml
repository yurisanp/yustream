<?xml version="1.0" encoding="UTF-8"?>
<VirtualHost>
    <Name>default</Name>

    <Host>
        <Names>
            <Name>*</Name>
        </Names>
        <TLS>
            <CertPath>/opt/ovenmediaengine/bin/origin_conf/cert.pem</CertPath>
            <KeyPath>/opt/ovenmediaengine/bin/origin_conf/privkey.pem</KeyPath>
            <ChainCertPath>/opt/ovenmediaengine/bin/origin_conf/chain.pem</ChainCertPath>
        </TLS>
    </Host>

    <!-- Admission Webhooks para controle de acesso -->
    <AdmissionWebhooks>
        <ControlServerUrl>http://yustream-auth:3001/webhook/admission</ControlServerUrl>
        <SecretKey>yustream-webhook-secret-2024</SecretKey>
        <Timeout>30000</Timeout>
        <Enables>
            <Providers>rtmp</Providers>
            <Publishers>llhls</Publishers>
        </Enables>
    </AdmissionWebhooks>

    <Applications>
        <Application>
            <Name>live</Name>
            <Type>live</Type>

            <!-- Perfis de saída com múltiplas qualidades -->
            <OutputProfiles>
                <!-- Perfil ABR (Adaptive Bitrate) com múltiplas qualidades -->
                <OutputProfile>
                    <Name>abr_stream</Name>
                    <OutputStreamName>${OriginStreamName}</OutputStreamName>
                    <Playlist>
                        <Name>for LLHLS</Name>
                        <FileName>abr</FileName>
                        <Rendition>
                            <Name>Fonte</Name>
                            <Video>bypass_video</Video>
                            <Audio>bypass_audio</Audio>
                        </Rendition>
                    </Playlist>
                    <Encodes>
                        <!-- Configuração de áudio -->
                        <Audio>
                            <Name>bypass_audio</Name>
                            <Bypass>True</Bypass>
                        </Audio>
                        <Video>
                            <Name>bypass_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                    </Encodes>
                </OutputProfile>
            </OutputProfiles>

            <!-- Configurações de provedores -->
            <Providers>
                <RTMP>
                    <BlockDuplicateStreamName>false</BlockDuplicateStreamName>
                </RTMP>
            </Providers>

            <!-- Configurações de publicadores -->
            <Publishers>
                <AppWorkerCount>1</AppWorkerCount>
                <StreamWorkerCount>8</StreamWorkerCount>               
                <LLHLS>
                    <SegmentDuration>4</SegmentDuration>
                    <SegmentCount>10</SegmentCount>
                    <PartHoldBack>7</PartHoldBack>
                    <CrossDomains>
                        <Url>*</Url>
                    </CrossDomains>
                </LLHLS>  
            </Publishers>
        </Application>
    </Applications>
</VirtualHost>
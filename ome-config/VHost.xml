<?xml version="1.0" encoding="UTF-8"?>
<!-- 
    Configuração do OvenMediaEngine para múltiplas entradas RTMP com adaptive bitrate
    Usando Multiplex Channel conforme documentação oficial
    
    Como usar:
    1. Configure seu encoder para enviar streams RTMP para diferentes qualidades:
       - rtmp://seu-servidor:1935/live/fonte_input
       - rtmp://seu-servidor:1935/live/1080p_input  
       - rtmp://seu-servidor:1935/live/720p_input
    
    2. O OME irá processar cada entrada com bypass (sem re-encoding)
    3. O Multiplex Channel combinará as streams em uma única stream ABR
    4. Acesse a stream combinada em:
       - https://seu-servidor:8080/live/abr_stream/abr.m3u8
    
    5. Os clientes receberão automaticamente a melhor qualidade baseada na largura de banda
-->
<VirtualHost>
    <Name>default</Name>

    <Host>
        <Names>
            <Name>*</Name>
        </Names>
        <TLS>
            <CertPath>/opt/ovenmediaengine/bin/origin_conf/cert.pem</CertPath>
            <KeyPath>/opt/ovenmediaengine/bin/origin_conf/privkey.pem</KeyPath>
            <ChainCertPath>/opt/ovenmediaengine/bin/origin_conf/chain.pem</ChainCertPath>
        </TLS>
    </Host>

    <!-- Admission Webhooks para controle de acesso -->
    <AdmissionWebhooks>
        <ControlServerUrl>http://yustream-auth:3001/webhook/admission</ControlServerUrl>
        <SecretKey>yustream-webhook-secret-2024</SecretKey>
        <Timeout>3000</Timeout>
        <Enables>
            <Publishers>llhls,webrtc</Publishers>
        </Enables>
    </AdmissionWebhooks>

    <Applications>
        <Application>
            <Name>live</Name>
            <Type>live</Type>

            <!-- Configurações de provedores -->
            <Providers>
                <!-- Multiplex Provider para combinar múltiplas streams -->
                <RTMP>
                    <BlockDuplicateStreamName>true</BlockDuplicateStreamName>
                </RTMP>
            </Providers>
            <OutputProfiles>
                <OutputProfile>
                    <Name>abr_stream</Name>
                    <OutputStreamName>${OriginStreamName}</OutputStreamName>
                    <Playlist>
                        <Name>abr_webrtc</Name>
                        <FileName>abr_webrtc</FileName>
                        <Options>
                            <WebRtcAutoAbr>true</WebRtcAutoAbr> 
                        </Options>
                        <Rendition>
                            <Name>Fonte</Name>
                            <Video>bypass_video</Video>
                            <Audio>opus_audio</Audio>
                        </Rendition>
                    </Playlist>
                    <Playlist>
                        <Name>ABR WHIP</Name>
                        <FileName>abr</FileName>
                        <Rendition>
                            <Name>Fonte</Name>
                            <Video>bypass_video</Video>
                            <Audio>aac_audio</Audio>
                        </Rendition>
                    </Playlist>
                    <Encodes>
                        <Video>
                            <Name>bypass_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                        <Audio>
                            <Name>opus_audio</Name>
                            <Codec>opus</Codec>
                            <Bitrate>160000</Bitrate>
                            <Samplerate>48000</Samplerate>
                            <Channel>2</Channel>
                            <BypassIfMatch>
                                <Codec>eq</Codec>
                            </BypassIfMatch>
                        </Audio>
                        <Audio>
                            <Name>aac_audio</Name>
                            <Codec>aac</Codec>
                            <Bitrate>160000</Bitrate>
                            <Samplerate>48000</Samplerate>
                            <Channel>2</Channel>
                            <BypassIfMatch>
                                <Codec>eq</Codec>
                            </BypassIfMatch>
                        </Audio>
                    </Encodes>
                </OutputProfile>
            </OutputProfiles>
            <!-- Configurações de publicadores -->
            <Publishers>
                <AppWorkerCount>1</AppWorkerCount>
                <StreamWorkerCount>4</StreamWorkerCount>               
                <LLHLS>
                    <SegmentDuration>4</SegmentDuration>
                    <SegmentCount>10</SegmentCount>
                    <PartHoldBack>7</PartHoldBack>
                    <CrossDomains>
                        <Url>*</Url>
                    </CrossDomains>
                </LLHLS>
                <WebRTC>
                    <Timeout>30000</Timeout>
                    <Rtx>false</Rtx>
                    <Ulpfec>false</Ulpfec>
                    <JitterBuffer>false</JitterBuffer>
                </WebRTC> 
            </Publishers>
        </Application>
    </Applications>
</VirtualHost>
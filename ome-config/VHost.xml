<?xml version="1.0" encoding="UTF-8"?>
<!-- 
    Configuração do OvenMediaEngine para múltiplas entradas RTMP com adaptive bitrate
    Usando Multiplex Channel conforme documentação oficial
    
    Como usar:
    1. Configure seu encoder para enviar streams RTMP para diferentes qualidades:
       - rtmp://seu-servidor:1935/live/fonte_input
       - rtmp://seu-servidor:1935/live/1080p_input  
       - rtmp://seu-servidor:1935/live/720p_input
    
    2. O OME irá processar cada entrada com bypass (sem re-encoding)
    3. O Multiplex Channel combinará as streams em uma única stream ABR
    4. Acesse a stream combinada em:
       - https://seu-servidor:8080/live/abr_stream/abr.m3u8
    
    5. Os clientes receberão automaticamente a melhor qualidade baseada na largura de banda
-->
<VirtualHost>
    <Name>default</Name>

    <Host>
        <Names>
            <Name>*</Name>
        </Names>
        <TLS>
            <CertPath>/opt/ovenmediaengine/bin/origin_conf/cert.pem</CertPath>
            <KeyPath>/opt/ovenmediaengine/bin/origin_conf/privkey.pem</KeyPath>
            <ChainCertPath>/opt/ovenmediaengine/bin/origin_conf/chain.pem</ChainCertPath>
        </TLS>
    </Host>

    <!-- Admission Webhooks para controle de acesso -->
    <AdmissionWebhooks>
        <ControlServerUrl>http://yustream-auth:3001/webhook/admission</ControlServerUrl>
        <SecretKey>yustream-webhook-secret-2024</SecretKey>
        <Timeout>3000</Timeout>
        <Enables>
            <Publishers>llhls</Publishers>
        </Enables>
    </AdmissionWebhooks>

    <Applications>
        <Application>
            <Name>live</Name>
            <Type>live</Type>

            <!-- Configurações de provedores -->
            <Providers>
                <!-- Multiplex Provider para combinar múltiplas streams -->
                <Multiplex>
                    <MuxFilesDir>mux_files</MuxFilesDir>
                </Multiplex>
            </Providers>

            <!-- Configurações de publicadores -->
            <Publishers>
                <AppWorkerCount>2</AppWorkerCount>
                <StreamWorkerCount>2</StreamWorkerCount>
                <LLHLS>
                    <ChunkDuration>0.2</ChunkDuration>
                    <SegmentDuration>6</SegmentDuration>
                    <SegmentCount>10</SegmentCount>
                    <CrossDomains>
                        <Url>*</Url>
                    </CrossDomains>
                </LLHLS>
            </Publishers>
        </Application>
        <Application>
            <Name>fonte</Name>
            <Type>live</Type>

            <!-- Perfis de saída com múltiplas qualidades -->
            <OutputProfiles>
                <!-- Perfil ABR (Adaptive Bitrate) com múltiplas qualidades -->
                <OutputProfile>
                    <Name>fonte</Name>
                    <OutputStreamName>${OriginStreamName}</OutputStreamName>
                    <Encodes>
                        <!-- Configuração de áudio -->
                        <Audio>
                            <Name>bypass_audio</Name>
                            <Bypass>True</Bypass>
                        </Audio>
                        <Video>
                            <Name>bypass_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                    </Encodes>
                </OutputProfile>
            </OutputProfiles>

            <!-- Configurações de provedores -->
            <Providers>
                <RTMP>
                    <BlockDuplicateStreamName>true</BlockDuplicateStreamName>
                </RTMP>
            </Providers>
        </Application>
        <Application>
            <Name>720</Name>
            <Type>live</Type>

            <!-- Perfis de saída com múltiplas qualidades -->
            <OutputProfiles>
                <!-- Perfil ABR (Adaptive Bitrate) com múltiplas qualidades -->
                <OutputProfile>
                    <Name>720</Name>
                    <OutputStreamName>${OriginStreamName}</OutputStreamName>
                    <Encodes>
                        <!-- Configuração de áudio -->
                        <Audio>
                            <Name>bypass_audio</Name>
                            <Bypass>True</Bypass>
                        </Audio>
                        <Video>
                            <Name>bypass_video</Name>
                            <Bypass>True</Bypass>
                        </Video>
                    </Encodes>
                </OutputProfile>
            </OutputProfiles>

            <!-- Configurações de provedores -->
            <Providers>
                <RTMP>
                    <BlockDuplicateStreamName>true</BlockDuplicateStreamName>
                </RTMP>
            </Providers>
        </Application>
    </Applications>
</VirtualHost>
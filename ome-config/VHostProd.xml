<?xml version="1.0" encoding="UTF-8"?>
<!-- 
    Configuração do OvenMediaEngine para múltiplas entradas RTMP com adaptive bitrate
    Usando Multiplex Channel conforme documentação oficial
    
    Como usar:
    1. Configure seu encoder para enviar streams RTMP para diferentes qualidades:
       - rtmp://seu-servidor:1935/live/fonte_input
       - rtmp://seu-servidor:1935/live/1080p_input  
       - rtmp://seu-servidor:1935/live/720p_input
    
    2. O OME irá processar cada entrada com bypass (sem re-encoding)
    3. O Multiplex Channel combinará as streams em uma única stream ABR
    4. Acesse a stream combinada em:
       - https://seu-servidor:8080/live/abr_stream/abr.m3u8
    
    5. Os clientes receberão automaticamente a melhor qualidade baseada na largura de banda
-->
<VirtualHost>
    <Name>default</Name>

    <Host>
        <Names>
            <Name>*</Name>
        </Names>
        <TLS>
            <CertPath>/opt/ovenmediaengine/bin/ssl_conf/cert.pem</CertPath>
            <KeyPath>/opt/ovenmediaengine/bin/ssl_conf/privkey.pem</KeyPath>
            <ChainCertPath>/opt/ovenmediaengine/bin/ssl_conf/chain.pem</ChainCertPath>
        </TLS>
    </Host>
    <OriginMapStore>
        <RedisServer>
            <Host>yustream-htg:6379</Host>
            <Auth></Auth>
        </RedisServer>
    </OriginMapStore>

    <!-- Admission Webhooks para controle de acesso -->
    <AdmissionWebhooks>
        <ControlServerUrl>http://127.0.0.1:3001/webhook/admission</ControlServerUrl>
        <SecretKey>yustream-webhook-secret-2024</SecretKey>
        <Timeout>3000</Timeout>
        <Enables>
            <Publishers>hls,llhls</Publishers>
        </Enables>
    </AdmissionWebhooks>

    <!-- <AdmissionWebhooks>
        <ControlServerUrl>http://yustream-auth:3001/webhook/admission</ControlServerUrl>
        <SecretKey>yustream-webhook-secret-2024</SecretKey>
        <Timeout>3000</Timeout>
        <Enables>
            <Publishers>hls,llhls</Publishers>
        </Enables>
    </AdmissionWebhooks> -->

    <Applications>
        <Application>
            <Name>*</Name>
            <Type>live</Type>
            <Providers>
                <OVT />
            </Providers>
            <Publishers>
                <AppWorkerCount>2</AppWorkerCount>
                <StreamWorkerCount>2</StreamWorkerCount>
                <LLHLS>
                    <ChunkDuration>0.2</ChunkDuration>
                    <SegmentDuration>6</SegmentDuration>
                    <SegmentCount>10</SegmentCount>
                    <CrossDomains>
                        <Url>*</Url>
                    </CrossDomains>
                </LLHLS>
                <HLS>
                    <SegmentCount>5</SegmentCount>
                    <SegmentDuration>6</SegmentDuration>
                    <CrossDomains>
                        <Url>*</Url>
                    </CrossDomains>
                </HLS>
            </Publishers>
        </Application>
    </Applications>
</VirtualHost>